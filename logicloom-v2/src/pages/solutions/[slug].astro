---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { Icon } from 'astro-icon/components';
import ArchitectureVisual from '../../components/visuals/ArchitectureVisual.astro';

export async function getStaticPaths() {
  const studies = await getCollection('case-studies');
  return studies.map((study) => ({
    params: { slug: study.slug },
    props: study,
  }));
}

const study = Astro.props;
const { Content } = await study.render();

const { 
  title, 
  description, 
  metric, 
  industry, 
  publishDate, 
  tags, 
  stats, 
  codeSnippet, 
  visualType, // This now controls the visual
  visualData  // This passes the data
} = study.data;
---

<Layout title={`${title} | LogicLoom Blueprints`} description={description}>
  
  <section class="relative pt-32 pb-20 px-6 bg-slate-50 border-b border-gray-200 overflow-hidden">
    <div class="absolute inset-0 opacity-[0.05]" style="background-image: linear-gradient(#94a3b8 1px, transparent 1px), linear-gradient(to right, #94a3b8 1px, transparent 1px); background-size: 40px 40px;"></div>
    
    <div class="max-w-7xl mx-auto relative z-10 grid lg:grid-cols-2 gap-16 items-center">
      
      <div>
        <div class="flex items-center gap-3 mb-8">
          <span class="px-4 py-1.5 rounded-full bg-slate-900 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg shadow-slate-900/20">
            {industry}
          </span>
          {publishDate && (
            <span class="text-slate-400 text-xs font-mono font-medium">
              // {new Date(publishDate).toISOString().split('T')[0]}
            </span>
          )}
        </div>

        <h1 class="font-display text-5xl md:text-7xl font-bold text-slate-900 mb-6 leading-[0.9] tracking-tight">
          {title}
        </h1>
        
        <p class="text-xl md:text-2xl text-slate-500 mb-10 leading-relaxed font-light">
          {description}
        </p>

        <div class="flex flex-wrap gap-2">
          {tags.map((tag) => (
            <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-white border border-gray-200 rounded-lg text-xs font-mono text-slate-600 shadow-sm">
              <Icon name="ph:hash" class="text-blue-500" /> {tag}
            </span>
          ))}
        </div>
      </div>

      <div class="relative w-full flex justify-center lg:justify-end">
        
        <div class="relative w-full max-w-lg perspective-1000 group">
            
            <div class="relative z-20 transform transition-all duration-700 group-hover:rotate-0 rotate-1">
               <ArchitectureVisual type={visualType || 'logic'} data={visualData} />
            </div>

            <div class="absolute -inset-4 bg-gradient-to-r from-blue-500/20 to-purple-500/20 blur-2xl opacity-50 z-0"></div>

            {metric && (
              <div class="absolute -bottom-6 -left-6 z-30 bg-slate-900 text-white p-4 rounded-xl shadow-2xl shadow-slate-900/40 flex items-center gap-3 border border-slate-700 animate-fade-in-up">
                  <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center text-white text-xl shadow-inner shadow-black/10">
                    <Icon name="ph:trend-up" />
                  </div>
                  <div>
                    <div class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Outcome</div>
                    <div class="text-xl font-bold leading-none">{metric}</div>
                  </div>
              </div>
            )}
        </div>

      </div>

    </div>
  </section>

  {stats && (
    <div class="border-b border-gray-200 bg-white sticky top-0 z-40 backdrop-blur-xl bg-white/90 supports-[backdrop-filter]:bg-white/60">
      <div class="max-w-7xl mx-auto px-6">
        <div class="grid grid-cols-2 md:grid-cols-4 divide-x divide-gray-100">
          {stats.map((stat) => (
            <div class="py-6 px-6 text-center md:text-left hover:bg-slate-50 transition-colors group cursor-default">
              <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1 group-hover:text-blue-600 transition-colors">{stat.label}</div>
              <div class="text-2xl md:text-3xl font-display font-bold text-slate-900">{stat.value}</div>
            </div>
          ))}
        </div>
      </div>
    </div>
  )}

  <section class="py-24 px-6 bg-white">
    <div class="max-w-7xl mx-auto grid lg:grid-cols-12 gap-16">
      
      <div class="lg:col-span-7">
        <div class="prose prose-lg prose-slate prose-headings:font-display prose-headings:font-bold prose-blue max-w-none prose-p:leading-relaxed prose-li:marker:text-blue-500">
          <Content />
        </div>
      </div>

      <div class="lg:col-span-5 space-y-8">
        <div class="sticky top-40 space-y-8">
          
          {codeSnippet && (
            <div class="rounded-3xl overflow-hidden bg-[#0f172a] shadow-2xl shadow-blue-900/20 ring-1 ring-slate-900/5">
              <div class="flex items-center justify-between px-6 py-4 bg-[#1e293b] border-b border-slate-700">
                <div class="flex gap-2">
                  <div class="w-3 h-3 rounded-full bg-[#ff5f56]"></div>
                  <div class="w-3 h-3 rounded-full bg-[#ffbd2e]"></div>
                  <div class="w-3 h-3 rounded-full bg-[#27c93f]"></div>
                </div>
                <div class="text-xs font-mono text-slate-400">{codeSnippet.filename}</div>
              </div>
              <div class="p-6 overflow-x-auto custom-scrollbar">
                <pre class="font-mono text-xs md:text-sm leading-7 text-blue-100"><code>{codeSnippet.code}</code></pre>
              </div>
            </div>
          )}

          <div class="bg-blue-600 rounded-3xl p-8 text-center shadow-xl shadow-blue-600/20 relative overflow-hidden group">
            <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
            <div class="relative z-10">
              <h3 class="text-xl font-bold text-white mb-2">Need this Logic?</h3>
              <p class="text-blue-100 mb-6 text-sm">
                We can deploy this architecture into your business in under 14 days.
              </p>
              <a href="/audit" class="inline-flex w-full items-center justify-center px-6 py-4 bg-white text-blue-900 font-bold rounded-xl hover:bg-blue-50 transition-colors shadow-lg">
                Book Feasibility Audit
              </a>
            </div>
          </div>

        </div>
      </div>

    </div>
    
  </section>
  {study.data.related && (
    <section class="border-t border-gray-200 bg-slate-50 py-20">
      <div class="max-w-4xl mx-auto px-6 text-center">
        <p class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4">Up Next</p>
        <h2 class="font-display text-3xl md:text-4xl font-bold text-slate-900 mb-6">
          {study.data.ctaText || "Ready for the next step?"}
        </h2>
        <a href={`/solutions/${study.data.related}`} class="group inline-flex items-center gap-2 text-blue-600 font-bold text-lg hover:text-blue-800 transition-colors">
          Continue the Journey <Icon name="ph:arrow-right" class="group-hover:translate-x-1 transition-transform" />
        </a>
      </div>
    </section>
  )}

</Layout>

<style is:global>
  /* 1. Make Tables Look Like Cards */
  .prose table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin: 2rem 0;
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
  }
  
  .prose thead {
    background-color: #f8fafc;
  }
  
  .prose th {
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
    color: #64748b;
    padding: 1rem 1.5rem;
    font-weight: 700;
    border-bottom: 1px solid #e2e8f0;
  }
  
  .prose td {
    padding: 1rem 1.5rem;
    font-size: 0.95rem;
    border-bottom: 1px solid #f1f5f9;
    color: #334155;
    vertical-align: top;
  }

  .prose tr:last-child td {
    border-bottom: none;
  }

  /* 2. Style The Logic List Numbers (THE MAIN STEPS) */
  .prose ol {
    counter-reset: list-counter;
    list-style: none;
    padding-left: 0;
  }
  
  /* Target Top-Level List Items */
  .prose ol > li {
    position: relative;
    padding-left: 3.5rem;
    margin-bottom: 2rem;
  }
  
  .prose ol > li::before {
    counter-increment: list-counter;
    content: counter(list-counter);
    position: absolute;
    left: 0;
    top: 0;
    width: 2.5rem;
    height: 2.5rem;
    background-color: #eff6ff;
    color: #2563eb;
    border-radius: 12px;
    font-weight: 800;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    border: 1px solid #dbeafe;
  }

  /* 3. FIX: RESET NESTED LISTS */
  .prose ol li ul, 
  .prose ol li ol {
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
  }

  .prose ol li ul li,
  .prose ol li ol li {
    padding-left: 1.5rem !important; /* Standard indent */
    margin-bottom: 0.5rem;
  }

  /* Turn the big number into a small grey dot for nested items */
  .prose ol li ul li::before,
  .prose ol li ol li::before {
    content: "" !important;
    width: 6px !important;
    height: 6px !important;
    background-color: #cbd5e1 !important;
    border-radius: 50%;
    border: none !important;
    top: 0.6em !important;
    left: 0 !important;
    display: block;
    font-size: 0;
  }
  
  /* 4. MAKE HEADLINES STAND OUT */
  .prose h2 {
    font-size: 1.8rem;
    letter-spacing: -0.02em;
    margin-top: 3rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #f1f5f9;
  }

  /* 5. MAKE THE "INTRO TEXT" LOOK LIKE A LEAD */
  .prose h2 + p {
    font-size: 1.25rem;
    line-height: 1.6;
    color: #475569;
    margin-bottom: 2rem;
    font-weight: 500;
    border-left: 4px solid #cbd5e1; 
    padding-left: 1.5rem;
  }

  .prose strong {
    color: #0f172a;
    font-weight: 700;
  }
</style>